<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 驻住专</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #111827; color: #f9fafb; }
        .screen { width: 100%; max-width: 1200px; margin: auto; padding: 2rem 1rem; animation: fadeIn .6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-text { background-image: linear-gradient(to right, #60a5fa, #c084fc); -webkit-background-clip: text; background-clip: text; color: transparent; }
        
        /* Horizontal Scroll for Word Banks */
        .bank-menu-container { display: flex; overflow-x: auto; padding-bottom: 1.5rem; scrollbar-width: thin; scrollbar-color: #4f46e5 #1f2937; }
        .bank-menu-container::-webkit-scrollbar { height: 8px; }
        .bank-menu-container::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 10px; }
        .bank-menu-container::-webkit-scrollbar-track { background-color: #1f2937; }

        .bank-button {
            flex-shrink: 0;
            width: 180px;
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 1rem;
            padding: 1.5rem 1rem;
            margin-left: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all .3s ease;
        }
        .bank-button:hover, .bank-button.active {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px -5px rgba(99,102,241,.25);
            border-color: #4f46e5;
        }
        .progress-bar-bg { background-color: #374151; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 0.75rem; }
        .progress-bar-fill { background-color: #6366f1; height: 100%; width: 0%; transition: width .5s ease; }
        
        .game-card { background-color: #1f2937; border: 1px solid #374151; border-radius: 1rem; padding: 2rem; text-align: center; transition: all .3s ease; cursor: pointer; color: inherit; text-decoration: none; }
        .game-card:hover { transform: translateY(-12px) scale(1.03); box-shadow: 0 25px 50px -12px rgba(99,102,241,.25); border-color: #4f46e5; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="user-greeting-container"></div>
    <div id="loading-screen" class="screen text-center"><h1 class="text-3xl font-bold gradient-text">注...</h1></div>

    <main id="psico-screen" class="screen hidden">
        <h1 class="text-5xl md:text-6xl font-bold mb-4 text-center gradient-text"> 驻住专</h1>
        <p class="text-xl text-gray-300 mb-12 text-center">专 专   转</p>

        <div id="bank-menu" class="bank-menu-container">
            </div>

        <div id="games-section" class="mt-16 hidden">
            <h2 id="games-section-title" class="text-3xl font-bold mb-8 text-center"></h2>
            <div id="game-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { wordBanks } from './word-banks.js'; //  专 

    const firebaseConfig = {
        apiKey: "AIzaSyDJIS34Bg2KWa28WQU46wV5dtDsw8qZEVM",
        authDomain: "english-4-you-fb80b.firebaseapp.com",
        projectId: "english-4-you-fb80b",
        storageBucket: "english-4-you-fb80b.appspot.com",
        messagingSenderId: "974140187099",
        appId: "1:974140187099:web:97484c5cfc8a15d27b47fe",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI Elements ---
    const loadingScreen = document.getElementById('loading-screen');
    const psicoScreen = document.getElementById('psico-screen');
    const bankMenu = document.getElementById('bank-menu');
    const gamesSection = document.getElementById('games-section');
    const gamesSectionTitle = document.getElementById('games-section-title');
    const gameGrid = document.getElementById('game-grid');

    // --- User Greeting Header ---
     function createHeader(userData) {
        const container = document.getElementById('user-greeting-container');
        if (!container) return;
        container.innerHTML = '';
        const greetingDiv = document.createElement('div');
        greetingDiv.className = 'fixed top-4 right-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm text-white py-2 px-4 rounded-lg shadow-lg cursor-pointer z-50';
        const now = new Date();
        const hour = now.getHours();
        let timeGreeting = (hour >= 5 && hour < 12) ? '拽专 ' : (hour >= 12 && hour < 18) ? '爪专 ' : '注专 ';
        greetingDiv.textContent = `${timeGreeting}, ${userData.name || '专'}`;
        greetingDiv.addEventListener('click', () => {
            if (confirm(' 转  砖专爪 转转拽?')) {
                signOut(auth).catch(error => console.error('Sign out error', error));
            }
        });
        container.appendChild(greetingDiv);
    }

    // --- Auth State ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            getDoc(doc(db, "users", user.uid)).then(docSnap => {
                if (docSnap.exists() && docSnap.data().forPsychometric) {
                    const userData = docSnap.data();
                    createHeader(userData);
                    initializePsicoHub(user);
                } else {
                    window.location.href = 'login.html'; // Redirect if not a psico user or doesn't exist
                }
            });
        } else {
            window.location.href = 'login.html';
        }
    });

    // --- Main Hub Logic ---
    async function initializePsicoHub(user) {
        // Fetch all progress documents for the user
        const progressCollectionRef = collection(db, "users", user.uid, "progress");
        const progressSnapshot = await getDocs(progressCollectionRef);
        const userProgress = {};
        progressSnapshot.forEach(doc => {
            userProgress[doc.id] = doc.data();
        });

        bankMenu.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            const bankId = `bank${i}`;
            const bankData = userProgress[bankId];
            const totalWordsInBank = wordBanks[i] ? wordBanks[i].length : 0;
            const knownWordsCount = bankData?.knownWords?.length || 0;
            
            let progressPercentage = 0;
            if (totalWordsInBank > 0) {
                progressPercentage = Math.round((knownWordsCount / totalWordsInBank) * 100);
            }

            const button = document.createElement('div');
            button.className = 'bank-button';
            button.dataset.bankId = i;
            button.innerHTML = `
                <h3 class="text-xl font-bold">专  ${i}</h3>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div>
                </div>
                <p class="text-sm text-gray-400 mt-2">${progressPercentage}%</p>
            `;

            button.addEventListener('click', () => {
                // Highlight active button
                document.querySelectorAll('.bank-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                showGamesForBank(i);
            });

            bankMenu.appendChild(button);
        }

        loadingScreen.classList.add('hidden');
        psicoScreen.classList.remove('hidden');
    }

    function showGamesForBank(bankId) {
        gamesSectionTitle.textContent = `砖拽 注专 专 ${bankId}`;
        gamesSection.classList.remove('hidden');
        gameGrid.innerHTML = ''; // Clear previous games

        // Define games for psychometric
        const psicoGames = {
            'flashcards': { 
                title: ' ', 
                file: `flashcard-game.html?bank=${bankId}`, 
                icon: '' 
            },
            'american-style': { 
                title: '专拽 住', 
                file: `american-style-quiz.html?bank=${bankId}`, 
                icon: '吼' 
            }
        };

        for (const [key, game] of Object.entries(psicoGames)) {
            const card = document.createElement('a');
            card.href = game.file;
            card.className = 'game-card';
            card.innerHTML = `
                <div class="text-5xl mb-4">${game.icon}</div>
                <h3 class="text-2xl font-bold">${game.title}</h3>
            `;
            gameGrid.appendChild(card);
        }
    }
</script>
</body>
</html>
